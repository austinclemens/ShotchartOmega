<html>
<head>
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script> 
	<script src="lib/kinetic_v5.1.0.min.js"></script>
	<script src="lib/jquery.csv-0.71.min.js"></script>
</head>
<style>body
{
	margin: 0;
	padding: 0;
} 
</style>
<body>

<div id="container"></div>

<script defer>
var shapes=[]
var group = new Kinetic.Group()
var linecounter=1


var width = window.innerWidth-30 || 900
if (width>1000) {
	width=1000
}

var stage = new Kinetic.Stage({
  container: 'container',
  width: width,
  height: (.716)*width,
  scaleX:width/900,
  scaleY:width/900,
});

var layer = new Kinetic.Layer({
	hitGraphEnabled: true,
	transformsEnabled: 'none',
	listening: true,
});

var circlayer = new Kinetic.Layer({
	hitGraphEnabled: true,
	transformsEnabled: 'none',
})

var court = new Kinetic.Layer();

stage.add(circlayer)

nba_court_base()

layer.on('click',function(evt){
	var shape=evt.target;

	var circle = new Kinetic.Circle({
		x: shape.attrs.xcenter,
		y: shape.attrs.ycenter,
		radius: 0,
		fillAlpha: .6,
		fillRed: 250,
		fillBlue: 250,
		fillGreen: 250,
		stroke: 'black',
		strokeWidth:2,
	});
	group.add(circle)
	circlayer.add(group)

	var tween = new Kinetic.Tween({
		node: circle, 
		duration: 1,
		easing: Kinetic.Easings.BackEaseOut,
		radius: 90
	});
	tween.play()

	setTimeout(function(){
		var text=new Kinetic.Text({fontStyle:'bold',x:shape.attrs.xcenter-24,y:shape.attrs.ycenter-65,fontSize:30,fontFamily:'Helvetica',fill:shape.attrs.fill,stroke:"#000000",strokeWidth:1,text: Math.round(shape.attrs.fg*100)+"%"})
		group.add(text)
		var text=new Kinetic.Text({align:'center',x:shape.attrs.xcenter-47,y:shape.attrs.ycenter-40,fontSize:17,fontFamily:'Verdana',fill:'#000000',text: "shots made"})
		group.add(text)

		if (Math.round(shape.attrs.shotvol*100)>9) {
			var text=new Kinetic.Text({fontStyle:'bold',x:shape.attrs.xcenter-24,y:shape.attrs.ycenter+15,fontSize:30,fontFamily:'Helvetica',fill:shape.attrs.fill,stroke:"#000000",strokeWidth:1,text: Math.round(shape.attrs.shotvol*100)+"%"})
			group.add(text)
		}
		if (Math.round(shape.attrs.shotvol*100)<10) {
			var text=new Kinetic.Text({fontStyle:'bold',x:shape.attrs.xcenter-16,y:shape.attrs.ycenter+15,fontSize:30,fontFamily:'Helvetica',fill:shape.attrs.fill,stroke:"#000000",strokeWidth:1,text: Math.round(shape.attrs.shotvol*100)+"%"})
			group.add(text)
		}

		var text=new Kinetic.Text({x:shape.attrs.xcenter-50,y:shape.attrs.ycenter+40,fontSize:17,fontFamily:'Verdana',fill:'#000000',text: "shot volume"})
		group.add(text)

		var circle = new Kinetic.Circle({
			x: shape.attrs.xcenter,
			y: shape.attrs.ycenter,
			radius: 2,
			opacity: 1,
			stroke: 'black',
			strokeWidth:1,
			fill: '#a0a0a0'
		})
		group.add(circle)

		var line=new Kinetic.Line({strokeWidth:1,dash: [5, 5],points:[shape.attrs.xcenter+3,shape.attrs.ycenter,shape.attrs.xcenter+90,shape.attrs.ycenter],stroke:'black'})
		group.add(line)

		var text=new Kinetic.Text({x:shape.attrs.xcenter+35,y:shape.attrs.ycenter-10,fontSize:9,fontFamily:'Helvetica',fill:'#000000',text: "5 feet"})
		group.add(text)
	},500)

	stage.add(circlayer)

})

circlayer.on('click',function(evt){
		group.removeChildren()
		circlayer.add(group)
})

window.onload=function() {
    var dict=[]
    dict.push({chart_type:get_param('chart_type'),player1:get_param('player1'),player2:get_param('player2'),player3:get_param('player3'),player4:get_param('player4'),player5:get_param('player5'),quarter:get_param('quarter'),startdate:get_param('startdate'),enddate:get_param('enddate'),offense_defense:get_param('offense_defense'),team:get_param('team'),year:get_param('year'),efficiency:get_param('efficiency'),season:get_param('season')})
    load_pshotnew(dict[0])
}

function get_param(name) {
    name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");
	var regexS = "[\\?&]"+name+"=([^&#]*)";
	var regex = new RegExp( regexS );
	var results = regex.exec( window.location.href );
	if( results == null )
		return null;
	else
		return results[1].replace("%20"," ");
}

function load_pshotnew(dict) {
	$.ajax({
	url: "http://www.austinclemens.com/cgi-bin/post.py",
	type: "post",
	datatype: "html",
	data:   dict,
	success: function(response){
		console.log(response)
		var shot_data = eval("(" + response + ")");
		circlayer.removeChildren()
		stage.add(circlayer)
		drawcourt_pshot(shot_data,"basic",0)
	}
	});
}

function drawcourt_pshot(shot_data,efficient) {
	
	layer.removeChildren()

	var text=new Kinetic.Text({x:350,y:21,width:280,fontSize:13,fontFamily:'Verdana',fill:'black',align:'left',text: shot_data[201]})
	layer.add(text)
	var text=new Kinetic.Text({x:40,y:21,width:280,fontSize:13,fontFamily:'Verdana',fill:'black',align:'left',text: shot_data[202]})
	layer.add(text)
	
	if(shot_data[203][0]!=3) {
		var text=new Kinetic.Text({x:40,y:5,fontSize:17,fontFamily:'Verdana',fill:'#000000',align:'right',text:'Player(s)'})
		layer.add(text)
	}

	if(shot_data[203][0]==3) {
		var text=new Kinetic.Text({x:40,y:5,fontSize:17,fontFamily:'Verdana',fill:'#000000',align:'right',text:'Team'})
		layer.add(text)
	}

	var max=shot_data[0][2]
	var min=shot_data[shot_data.length-4][2]
	var box_size=18

	stage.add(layer)

	for(var n = 0; n < 200; n++) {
		if (shot_data[n][2]>0 && shot_data[n][5]>0.005){
			var X = shot_data[n][1]*1.8+450+9 ;
  			var Y = shot_data[n][0]*1.8+144.5+9 ;

  			if(efficient=="efficiency") {
  				fillcolor=choosecolor_pps(shot_data[n][7])
  			}
  			if(efficient=="basic") {
  				fillcolor=choosecolor_pshot(shot_data[n][3],shot_data[203][0])
  			}

			var box = new Kinetic.Circle({
				//cornerRadius: 10,
				x: X,
				y: Y,
				xcenter: X,
				ycenter: Y,
				//shadowColor: '#000000',
				//shadowBlur: 10,
				// shadowOpacity: 1,
				radius:0,
				// stroke:'#000000',
				// strokeWidth: 0,
				shotvol: shot_data[n][5],
				fg: shot_data[n][4],
				fill: fillcolor,
			});
			layer.add(box);
		}
	}

	var shapes=layer.getChildren()

	for (var n=0; n < shapes.length; n++) {
		var rect=shapes[n]
		var maxwidth=choosesize(shot_data[n][2],min,max,22)

		var tween = new Kinetic.Tween({
			node: rect, 
			duration: 2,
			easing: Kinetic.Easings.ElasticEaseOut,
			radius:maxwidth/2,
		});
		tween.play()
	}
}

function shadow_layer(shot_data,min,max,efficient,dleague) {
	for(var n = 0; n < 200; n++) {
		if (shot_data[n][2]>0 && shot_data[n][6]>0.005){
			var X = shot_data[n][1]*1.8+450+((18-choosesize(shot_data[n][2],min,max,20))/2) ;
  			var Y = shot_data[n][0]*1.8+144.5+((18-choosesize(shot_data[n][2],min,max,20))/2) ;
  			var Xcenter = shot_data[n][1]*1.8+450+9
  			var Ycenter = shot_data[n][0]*1.8+94.5+9

  			if(efficient=="efficiency") {
  				fillcolor=choosecolor_pps(shot_data[n][7])
  			}
  			if(efficient=="basic") {
  				fillcolor=choosecolor_pshot(shot_data[n][3])
  			}

			var box = new Kinetic.Rect({
				cornerRadius: 3,
				x: X,
				y: Y,
				xcenter: Xcenter,
				ycenter: Ycenter,
				width: choosesize(shot_data[n][2],min,max,20),
				height: choosesize(shot_data[n][2],min,max,20),
				fill: fillcolor,
				shotvol: shot_data[n][8],
				fg: shot_data[n][4],
			});
		}
		layer.add(box);
	}
}


function choosesize(shots,min,max,side_length) {
	if (shots==0) {
		return 0
	}
	if (min==0) {
		var min=1
	}
	var shots=Math.log(shots)
	var min=Math.log(min)
	var max=Math.log(max)
	var fraction=(shots-min)/(max-min)
	var minsize=45
	var differential=(Math.pow(side_length,2)-minsize)
	var blah=Math.sqrt(fraction*differential+minsize)
	return Math.round(blah);
}

function choosecolor_pshot(coef,bit) {
	if (bit==3){
		if (coef>=.10) return '#a50026';
		if (coef>=.08 && coef<.10) return '#d73027';
		if (coef>=.06 && coef<.08) return '#f46d43';
		if (coef>=.04 && coef<.06) return '#fdae61';
		if (coef>=.02 && coef<.04) return '#fee090';
		if (coef>=-.02 && coef<.02) return '#ffffbf';
		if (coef>=-.04 && coef<-.02) return '#e0f3f8';
		if (coef>=-.06 && coef<-.04) return '#abd9e9';
		if (coef>=-.08 && coef<-.06) return '#74add1';
		if (coef>=-.10 && coef<-.08) return '#4575b4';
		if (coef<=-.10) return '#313695';
	}
	if (bit!=3){
		if (coef>=.15) return '#a50026';
		if (coef>=.12 && coef<.15) return '#d73027';
		if (coef>=.09 && coef<.12) return '#f46d43';
		if (coef>=.06 && coef<.09) return '#fdae61';
		if (coef>=.03 && coef<.06) return '#fee090';
		if (coef>=-.03 && coef<.03) return '#ffffbf';
		if (coef>=-.06 && coef<-.03) return '#e0f3f8';
		if (coef>=-.09 && coef<-.06) return '#abd9e9';
		if (coef>=-.12 && coef<-.09) return '#74add1';
		if (coef>=-.15 && coef<-.12) return '#4575b4';
		if (coef<=-.15) return '#313695';
	}
}

function choosecolor_pps(coef) {
	if (coef>=.40) return '#ff0000';
	if (coef>=.35 && coef<.40) return '#ff1e00';
	if (coef>=.30 && coef<.35) return '#ff3c00';
	if (coef>=.25 && coef<.30) return '#ff5a00';
	if (coef>=.20 && coef<.25) return '#ff7800';
	if (coef>=.15 && coef<.20) return '#ff9600';
	if (coef>=.10 && coef<.15) return '#ffb400';
	if (coef>=.05 && coef<.10) return '#ffd200';
	if (coef>=.00 && coef<.05) return '#ffffbf';
	if (coef>=-.05 && coef<.00) return '#ffffbf';
	if (coef>=-.10 && coef<-.05) return '#00d2ff';
	if (coef>=-.15 && coef<-.10) return '#00b4ff';
	if (coef>=-.20 && coef<-.15) return '#0096ff';
	if (coef>=-.25 && coef<-.20) return '#0078ff';
	if (coef>=-.30 && coef<-.25) return '#005aff';
	if (coef>=-.35 && coef<-.30) return '#003cff';
	if (coef<-.35) return '#001eff';
}

function nba_court_base() {
	var base=new Kinetic.Rect({x:54,y:50,width:792,height:255,fill:'#D0D0D0'})
	court.add(base)
	var base=new Kinetic.Rect({x:0,y:0,width:900,height:49,fill:'#ffffff'})
	court.add(base)
	var base=new Kinetic.Rect({x:0,y:50,width:54,height:590,fill:'#E0E0E0'})
	court.add(base)
	var base=new Kinetic.Rect({x:846,y:50,width:54,height:590,fill:'#E0E0E0'})
	court.add(base)
	var base=new Kinetic.Rect({x:0,y:305,width:900,height:339,fill:'#E0E0E0'})
	court.add(base)
	var arc=new Kinetic.Arc({x:450,y:144.5,innerRadius:427.5,outerRadius:127.5,angle:136,fill:'#D0D0D0',rotationDeg:22})
	court.add(arc)
	var arc=new Kinetic.Arc({strokeWidth:2,stroke:'white',x:450,y:144.5,innerRadius:427.5,outerRadius:427.5,angle:136,rotationDeg:22,shadowColor:'#ffffff',shadowBlur:100})
	court.add(arc)
	var base=new Kinetic.Rect({x:342,y:50,width:216,height:342,fill:'#C0C0C0'})
	court.add(base)
	var base=new Kinetic.Rect({x:306,y:50,width:36,height:342,fill:'#C0C0C0'})
	court.add(base)
	var base=new Kinetic.Rect({x:558,y:50,width:36,height:342,fill:'#C0C0C0'})
	court.add(base)

	var line=new Kinetic.Line({strokeWidth:1,points:[0,50,900,50],stroke:'black'})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:1,points:[0,643,900,643],stroke:'black'})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[0,643,0,51],stroke:'black'})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[900,643,900,51],stroke:'black'})
	court.add(line)

	var line=new Kinetic.Line({strokeWidth:2,points:[306,50,306,392],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[594,50,594,392],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[342,50,342,392],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[558,50,558,392],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[306,392,594,392],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[252,50,252,59],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[648,50,648,59],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[360,284,369,284],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[540,284,531,284],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[396,120.2,504,120.2],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[378,125.6,378,148.1],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[522,125.6,522,148.1],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[306,176,292.5,176],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[594,176,607.5,176],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[306,194,292.5,194],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[594,194,607.5,194],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[306,248,292.5,248],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[594,248,607.5,248],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[306,302,292.5,302],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[594,302,607.5,302],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)

	var arc=new Kinetic.Arc({innerRadius:27,outerRadius:27,strokeWidth:2,stroke:'white',x:450,y:148.1,angle:360,rotationDeg:0,shadowColor:'#ffffff',shadowBlur:100})
	court.add(arc)
	var arc=new Kinetic.Arc({strokeWidth:2,stroke:'white',x:450,y:392,innerRadius:108,outerRadius:108,angle:180,shadowColor:'#ffffff',shadowBlur:100})
	court.add(arc)
	var arc=new Kinetic.Arc({strokeWidth:2,stroke:'white',x:450,y:148.1,innerRadius:72,outerRadius:72,angle:180,shadowColor:'#ffffff',shadowBlur:100})
	court.add(arc)
	var arc=new Kinetic.Arc({strokeWidth:2,stroke:'white',x:450,y:392,innerRadius:108,outerRadius:108,angle:180,dash:[22,22],rotationDeg:180,shadowColor:'#ffffff',shadowBlur:100})
	court.add(arc)

	var line=new Kinetic.Line({strokeWidth:2,points:[54,50,54,305.6],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)
	var line=new Kinetic.Line({strokeWidth:2,points:[846,50,846,305.6],stroke:'white',shadowColor:'#ffffff',shadowBlur:100})
	court.add(line)

	var img = new Image()
	img.src="Twitter_logo_sm2.png"
	img.onload = function() {
		twit = new Kinetic.Image({
			x: 765,
        	y: 622,
        	image: img,
        	width: 17,
        	height: 14,
        });
        court.add(twit)
        court.draw()
    }
    
    var text=new Kinetic.Text({x:782,y:624,fontSize:13,fontFamily:'Helvetica',fill:'#000000',align:'right',text:'@AustinClemens2'})
	court.add(text)
	var text=new Kinetic.Text({x:10,y:624,fontSize:13,fontFamily:'Helvetica',fill:'#000000',align:'right',text:'www.nyloncalculus.com/shotchart'})
	court.add(text)

	var text=new Kinetic.Text({x:350,y:5,fontSize:17,fontFamily:'Verdana',fill:'#000000',align:'right',text:'Details'})
	court.add(text)
	// var text=new Kinetic.Text({x:700,y:5,fontSize:17,fontFamily:'Verdana',fill:'#000000',align:'left',text:'Key'})
	// court.add(text)

	var text=new Kinetic.Text({x:665,y:30,fontSize:10,fontFamily:'Verdana',fill:'#000000',align:'left',text:'< avg'})
	court.add(text)
	var text=new Kinetic.Text({x:825,y:30,fontSize:10,fontFamily:'Verdana',fill:'#000000',align:'left',text:'> avg'})
	court.add(text)
	var text=new Kinetic.Text({x:740,y:13,fontSize:10,fontFamily:'Verdana',fill:'#000000',align:'left',text:'average'})
	court.add(text)

	var box = new Kinetic.Circle({x: 710,y: 36, radius:10,fill: '#313695',stroke:'black',strokeWidth:1});
	court.add(box)
	var box = new Kinetic.Circle({x: 735,y: 36, radius:10,fill: '#abd9e9',stroke:'black',strokeWidth:1});
	court.add(box)
	var box = new Kinetic.Circle({x: 760,y: 36, radius:10,fill: '#ffffbf',stroke:'black',strokeWidth:1});
	court.add(box)
	var box = new Kinetic.Circle({x: 785,y: 36, radius:10,fill: '#fdae61',stroke:'black',strokeWidth:1});
	court.add(box)
	var box = new Kinetic.Circle({x: 810,y: 36, radius:10,fill: '#a50026',stroke:'black',strokeWidth:1});
	court.add(box)

	stage.add(court)
}

</script>

</body>
</html>